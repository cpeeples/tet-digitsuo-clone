/* ============================================================
 *  ████████▄   ▄█     ▄██████▄   ▄█      ███        ▄████████ ███    █▄   ▄██████▄
 *  ███   ▀███ ███    ███    ███ ███  ▀█████████▄   ███    ███ ███    ███ ███    ███
 *  ███    ███ ███▌   ███    █▀  ███▌    ▀███▀▀██   ███    █▀  ███    ███ ███    ███
 *  ███    ███ ███▌  ▄███        ███▌     ███   ▀   ███        ███    ███ ███    ███
 *  ███    ███ ███▌ ▀▀███ ████▄  ███▌     ███     ▀███████████ ███    ███ ███    ███
 *  ███    ███ ███    ███    ███ ███      ███              ███ ███    ███ ███    ███
 *  ███   ▄███ ███    ███    ███ ███      ███        ▄█    ███ ███    ███ ███    ███
 *  ████████▀  █▀     ████████▀  █▀      ▄████▀    ▄████████▀  ████████▀   ▀██████▀
 *
 *  Project     : DigitSuo
 *  Description : handwritten digit recognition system using a custom
 *                neural network architecture. Built with C, it features both training
 *                capabilities and an interactive recognition interface.
 *                >98% accuracy on the MNIST dataset.
 *  Version     : 1.0
 *  Author      : tetsuo.ai Dev Team :: x.com/7etsuo :: discord.gg/tetsuo-ai
 *  CA          : $Tetsuo on SOLANA  :: 8i51XNNpGaKaj4G4nDdmQh95v4FKAxw8mhtaRoKd9tE8
 *
 *  snowcrash, richinseattle, bobsuo, kokosuo, Petral.S
 *  ============================================================
 */

#include <stdio.h>
#include <stdlib.h>
#include <ncurses.h>
#include "draw_interface.h"
#include "neural_net.h"
#include "utils.h"

#define MIN_TERM_HEIGHT 10
#define MIN_TERM_WIDTH 40

#define MOUSE_TRACKING_ON "\033[?1002h"
#define MOUSE_ALL_EVENTS_ON "\033[?1003h"
#define MOUSE_EXTENDED_SGR_ON "\033[?1006h"
#define MOUSE_URXVT_ON "\033[?1015h"
#define MOUSE_BASIC_ON "\033[?1000h"

#define MOUSE_BASIC_OFF "\033[?1000l"
#define MOUSE_TRACKING_OFF "\033[?1002l"
#define MOUSE_ALL_EVENTS_OFF "\033[?1003l"
#define MOUSE_EXTENDED_SGR_OFF "\033[?1006l"
#define MOUSE_URXVT_OFF "\033[?1015l"

FILE *debug_log = NULL;

static const char *test_patterns[] = {"............................\n"
                                      "............................\n"
                                      "..........########..........\n"
                                      ".........##########.........\n"
                                      "........###......###........\n"
                                      ".......###........###.......\n"
                                      ".......###........###.......\n"
                                      "......###..........###......\n"
                                      "......###..........###......\n"
                                      "......###..........###......\n"
                                      "......###..........###......\n"
                                      "......###..........###......\n"
                                      "......###..........###......\n"
                                      "......###..........###......\n"
                                      ".......###........###.......\n"
                                      ".......###........###.......\n"
                                      "........###......###........\n"
                                      ".........##########.........\n"
                                      "..........########..........\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "............####............\n"
                                      "...........#####............\n"
                                      "..........######............\n"
                                      ".........#######............\n"
                                      "........########............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      "............###.............\n"
                                      ".........########...........\n"
                                      ".........########...........\n"
                                      ".........########...........\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      ".........##########.........\n"
                                      "........############........\n"
                                      ".......###........###.......\n"
                                      "..................###.......\n"
                                      "..................###.......\n"
                                      ".................###........\n"
                                      "................###.........\n"
                                      "...............###..........\n"
                                      "..............###...........\n"
                                      ".............###............\n"
                                      "............###.............\n"
                                      "...........###..............\n"
                                      "..........###...............\n"
                                      ".........###................\n"
                                      "........###.................\n"
                                      ".......###..................\n"
                                      "......###...................\n"
                                      ".....###....................\n"
                                      "....###################.....\n"
                                      "....###################.....\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "..........########..........\n"
                                      "........############........\n"
                                      ".......###........###.......\n"
                                      "......###..........###......\n"
                                      "..................###.......\n"
                                      ".................###........\n"
                                      "...........#######..........\n"
                                      "...........#######..........\n"
                                      ".................###........\n"
                                      "..................###.......\n"
                                      "..................###.......\n"
                                      "..................###.......\n"
                                      "..................###.......\n"
                                      "......###.........###......\n"
                                      ".......###........###......\n"
                                      "........###......###.......\n"
                                      ".........##########.........\n"
                                      "...........######...........\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "................###.........\n"
                                      "...............####.........\n"
                                      "..............#####.........\n"
                                      ".............######.........\n"
                                      "............###.###.........\n"
                                      "...........###..###.........\n"
                                      "..........###...###.........\n"
                                      ".........###....###.........\n"
                                      "........###.....###.........\n"
                                      ".......###......###.........\n"
                                      "......###.......###.........\n"
                                      ".....###........###.........\n"
                                      "....###.........###.........\n"
                                      "...##################........\n"
                                      "...##################........\n"
                                      "...##################........\n"
                                      "................###.........\n"
                                      "................###.........\n"
                                      "................###.........\n"
                                      "................###.........\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      ".......############.........\n"
                                      ".......############.........\n"
                                      ".......###..................\n"
                                      ".......###..................\n"
                                      ".......###..................\n"
                                      ".......###..................\n"
                                      ".......###############......\n"
                                      ".......###############......\n"
                                      "..................###.......\n"
                                      "...................###......\n"
                                      "...................###......\n"
                                      "...................###......\n"
                                      "...................###......\n"
                                      "...................###......\n"
                                      "......###.........###......\n"
                                      ".......###.......###.......\n"
                                      "........###.....###........\n"
                                      ".........#########.........\n"
                                      "...........#####...........\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "...........######...........\n"
                                      ".........########..........\n"
                                      "........###................\n"
                                      ".......###..................\n"
                                      "......###...................\n"
                                      ".....###....................\n"
                                      ".....###....................\n"
                                      ".....###....................\n"
                                      ".....###.#########.........\n"
                                      ".....#############.........\n"
                                      "....###..........###.......\n"
                                      "....###..........###.......\n"
                                      "....###..........###.......\n"
                                      "....###..........###.......\n"
                                      ".....###........###........\n"
                                      "......###......###.........\n"
                                      ".......##########..........\n"
                                      ".........######............\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "....##################......\n"
                                      "....##################......\n"
                                      "....##################......\n"
                                      "..................###.......\n"
                                      ".................###........\n"
                                      "................###.........\n"
                                      "...............###..........\n"
                                      "..............###...........\n"
                                      ".............###............\n"
                                      "............###.............\n"
                                      "...........###..............\n"
                                      "..........###...............\n"
                                      ".........###................\n"
                                      "........###.................\n"
                                      ".......###..................\n"
                                      "......###...................\n"
                                      ".....###....................\n"
                                      "....###.....................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "..........######............\n"
                                      "........##########..........\n"
                                      ".......###......###.........\n"
                                      "......###........###........\n"
                                      "......###........###........\n"
                                      "......###........###........\n"
                                      ".......###......###.........\n"
                                      "........########............\n"
                                      "........########............\n"
                                      ".......###......###.........\n"
                                      "......###........###........\n"
                                      "......###........###........\n"
                                      "......###........###........\n"
                                      "......###........###........\n"
                                      ".......###......###.........\n"
                                      "........##########..........\n"
                                      "..........######............\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................",
                                      "............................\n"
                                      "............................\n"
                                      "..........######............\n"
                                      "........##########..........\n"
                                      ".......###......###.........\n"
                                      "......###........###........\n"
                                      ".....###..........###.......\n"
                                      ".....###..........###.......\n"
                                      ".....###..........###.......\n"
                                      ".....###..........###.......\n"
                                      "......###........###........\n"
                                      ".......############.........\n"
                                      ".........##########.........\n"
                                      "...............###..........\n"
                                      "................###.........\n"
                                      "................###.........\n"
                                      ".......###......###.........\n"
                                      "........###....###..........\n"
                                      ".........########...........\n"
                                      "...........####.............\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................\n"
                                      "............................"};

static void update_cell(DrawGrid *grid, int x, int y, char c)
{
    if (y < GRID_SIZE && x < GRID_SIZE)
        grid->cells[y][x] = (c == '#') ? 1 : 0;
}

static void process_pattern_character(DrawGrid *grid, char c, int *x, int *y)
{
    if (c == '\n')
    {
        *x = 0;
        (*y)++;
    }
    else
    {
        update_cell(grid, *x, *y, c);
        (*x)++;
    }
}

static void draw_digit_pattern(DrawGrid *grid, int digit)
{
    if (digit < 0 || digit > 9)
        return;
    clear_grid(grid);
    const char *pattern = test_patterns[digit];
    int x = 0, y = 0;
    for (const char *p = pattern; *p != '\0'; p++)
        process_pattern_character(grid, *p, &x, &y);
}

static FILE *init_debug_log(void)
{
    FILE *log = fopen(DEBUG_LOG_PATH, "w");
    if (!log)
        fprintf(stderr, "Failed to open debug log\n");
    return log;
}

static void init_ncurses_mode(void)
{
    initscr();
    noecho();
    cbreak();
    keypad(stdscr, TRUE);
}

static int verify_terminal_size(FILE *log)
{
    int term_height, term_width;
    getmaxyx(stdscr, term_height, term_width);
    if (term_height < MIN_TERM_HEIGHT || term_width < MIN_TERM_WIDTH)
    {
        endwin();
        fprintf(stderr, "\033[2J\033[H");
        fprintf(stderr, "Terminal window too small!\n\n");
        fprintf(stderr, "Current terminal size: %dx%d\n", term_width, term_height);
        fprintf(stderr, "Required size: %dx%d\n\n", MIN_TERM_WIDTH, MIN_TERM_HEIGHT);
        fprintf(stderr, "Please resize your terminal and run again.\n");
        fprintf(stderr, "Tip: The Shell tab in Replit should be expanded.\n\n");
        if (log)
            fclose(log);
        return 0;
    }
    return 1;
}

static int init_systems(DrawGrid **grid, NeuralNet **net)
{
    *grid = init_grid();
    if (!*grid)
        return 0;
    *net = init_neural_net();
    if (!*net)
    {
        free_grid(*grid);
        return 0;
    }
    return 1;
}

static void enable_mouse_support(void)
{
    printf(MOUSE_TRACKING_ON);
    printf(MOUSE_ALL_EVENTS_ON);
    printf(MOUSE_EXTENDED_SGR_ON);
    printf(MOUSE_URXVT_ON);
    printf(MOUSE_BASIC_ON);
    mousemask(ALL_MOUSE_EVENTS | REPORT_MOUSE_POSITION, NULL);
    mouseinterval(0);
    curs_set(0);
    timeout(0);
}

static void disable_mouse_support(void)
{
    printf(MOUSE_BASIC_OFF);
    printf(MOUSE_TRACKING_OFF);
    printf(MOUSE_ALL_EVENTS_OFF);
    printf(MOUSE_EXTENDED_SGR_OFF);
    printf(MOUSE_URXVT_OFF);
}

static void print_controls(void)
{
    int info_x = (GRID_SIZE * 2) + 2;
    mvprintw(1, info_x, "Controls: 0-9: Digits");
    mvprintw(2, info_x, "Mouse/Arrow: Draw");
    mvprintw(3, info_x, "Enter: Submit  C: Clear");
    mvprintw(4, info_x, "Q: Quit");
}

static void process_digit_input(DrawGrid *grid, int ch)
{
    draw_digit_pattern(grid, ch - '0');
}

static void process_mouse_event(DrawGrid *grid, MEVENT *last_event)
{
    MEVENT event;
    if (getmouse(&event) == OK)
    {
        fprintf(debug_log, "Mouse event: x=%d, y=%d, bstate=0x%08lx\n", event.x, event.y, (unsigned long)event.bstate);
        fflush(debug_log);
        if (event.x != last_event->x || event.y != last_event->y)
        {
            handle_mouse_event(grid, event.x, event.y);
            *last_event = event;
        }
    }
}

static void process_submission(DrawGrid *grid, NeuralNet *net)
{
    float *input = preprocess_grid(grid);
    if (!input)
        return;
    float *output = forward_pass(net, input);
    free(input);
    if (!output)
        return;
    int prediction = get_prediction(output);
    mvprintw(GRID_SIZE + 1, 2, "Predicted: %d (Confidence: %.0f%%)    ", prediction, output[prediction] * 100.0f);
    mvprintw(GRID_SIZE + 2, 2, "Top 3: ");
    int top[3] = {0, 1, 2};
    for (int i = 3; i < 10; i++)
    {
        for (int j = 0; j < 3; j++)
        {
            if (output[i] > output[top[j]])
            {
                for (int k = 2; k > j; k--)
                    top[k] = top[k - 1];
                top[j] = i;
                break;
            }
        }
    }
    for (int i = 0; i < 3; i++)
        mvprintw(GRID_SIZE + 2, 12 + i * 15, "%d (%.0f%%)", top[i], output[top[i]] * 100.0f);
    free(output);
}

static int process_input(DrawGrid *grid, NeuralNet *net, MEVENT *last_event)
{
    int ch = getch();
    if (ch >= '0' && ch <= '9')
    {
        process_digit_input(grid, ch);
        return 1;
    }
    if (ch == KEY_MOUSE)
    {
        process_mouse_event(grid, last_event);
        return 1;
    }
    switch (ch)
    {
    case 'c':
    case 'C':
        clear_grid(grid);
        break;
    case '\n':
        process_submission(grid, net);
        break;
    case 'q':
    case 'Q':
        return 0;
    }
    return 1;
}

int main(void)
{
    debug_log = init_debug_log();
    if (!debug_log)
        return 1;
    init_ncurses_mode();
    if (!verify_terminal_size(debug_log))
        return 1;
    DrawGrid *grid = NULL;
    NeuralNet *net = NULL;
    if (!init_systems(&grid, &net))
    {
        endwin();
        fprintf(stderr, "Failed to initialize systems\n");
        fclose(debug_log);
        return 1;
    }
    enable_mouse_support();
    MEVENT last_event = {0};
    int running = 1;
    while (running)
    {
        draw_interface(grid);
        print_controls();
        refresh();
        running = process_input(grid, net, &last_event);
    }
    disable_mouse_support();
    free_neural_net(net);
    free_grid(grid);
    fclose(debug_log);
    endwin();
    return 0;
}
